<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <script id="tailwindcss" src="tailwindcss-3.4.14.js"></script>
</head>

<body class="bg-gray-100 dark:bg-gray-950 h-screen flex flex-col">
    <form id="propertiesForm" class="hidden bg-white dark:bg-gray-900 text-gray-700 dark:text-gray-200 fixed inset-x-0 inset-y-0 p-4 shadow-lg z-10">
        <div class="relative max-w-2xl mx-auto w-full space-y-3">
          <h2 class="border-b pb-2 dark:border-gray-700 font-bold">Settings</h2>
          <p class="text-sm font-thin">Add your preffered AI chat settings</p>
          <label class="block">
            <p class="block text-sm font-bold mb-2">API Key</p>
            <p class="block text-xs mb-2 font-thin -mt-1">AI service provider's API Key</p>
            <input name="api_key" type="text" required
                class="bg-gray-50 dark:bg-gray-800 dark:border-gray-700 w-full h-10 p-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 resize-none" />
          </label>
          <label class="block relative">
            <p class="block text-sm font-bold mb-2">Proxy Server URL</p>
            <p class="block text-xs mb-2 font-thin -mt-1">
              URL to a proxy service to enable running from a single on-device file.<br/>
              We recommended 
              <code
                class="text-green-500 dark:text-green-400 bg-green-50 dark:bg-green-950 px-1 rounded"
                onclick="this.parentElement.nextElementSibling.value = this.textContent"
              >https://cheap-lion-17.deno.dev?e=</code>
            </p>
            <input name="proxy" type="url" required
                class="bg-gray-50 dark:bg-gray-800 dark:border-gray-700 w-full h-10 p-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 resize-none" />
            <!-- <span class="r absolute border border-green-400 px-1 r right-3 rounded-sm text-green-400 text-xs top-10">recommended</span> -->
          </label>
          <div class="block">
            <button
                class="bg-yellow-400 dark:bg-yellow-500 text-black font-semibold px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 hover:bg-yellow-300 transition focus:bg-yellow-500/90 mt-2">
                Save Settings
            </button>
          </div>
        </div>
    </form>

    <div class="flex-1 overflow-y-auto p-4 w-full">
        <div id="chatContainer" class="space-y-4 max-w-2xl mx-auto w-full">
            <!-- Reusable message template -->
            <div id="messageTemplate" class="hidden message-template flex items-start gap-2">
                <div class="flex flex-col items-start w-full">
                    <div class="flex items-center mb-1">
                        <img src="" alt="Sender"
                            class="sender-avatar size-12 inline-block rounded-full p-2 mr-2 overflow-hidden align-middle bg-gray-300 bg-yellow-400 text-center leading-[2em]">
                        <span class="sender-name text-gray-600 font-semibold">Sender Name</span>
                    </div>
                    <div class="message-content bg-white p-3 rounded-lg">
                        <p class="message-text text-gray-800 whitespace-pre-wrap">Message Content</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form id="chatForm" class="p-4 shadow-lg relative">
      <!-- #TODO: loop through /models appending response - ->
      <label>
        <p class="block text-gray-700 text-sm font-bold mb-2">Model Name</p>
        <select name="model" type="text" required
            class="w-full h-10 p-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 resize-none mb-2">
            <option value="default">Default</option>
        </select>
      </label>
      <!- -  -->
    
        <div class="relative max-w-2xl mx-auto w-full">
            <textarea id="messageInput" placeholder="What do you wanna do?"
                class="bg-white dark:bg-gray-800 dark:border-gray-700 w-full h-32 p-4 pb-14 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 resize-none"
                rows="4"></textarea>
            <button type="submit"
              class="absolute bg-yellow-400 dark:bg-yellow-500 hover:bg-yellow-300 px-4 bottom-4 right-4 rounded-lg text-black transition">
              <span class="sr-only">Send</span>
              <i style="font: normal 32px/1 Georgia, serif; text-indent: -.45em;" class="block overflow-hidden w-3">&rbarr;</i>
              <!-- <i style="font: normal 32px/1.1 Georgia, serif; text-indent: -.45em;" class="block overflow-hidden w-3">&rbarr;</i> -->
            </button>
            <button type="button" onclick="document.getElementById('propertiesForm').classList.remove('hidden')"
              class="absolute bg-gray-100 dark:bg-gray-700 px-4 py-1 bottom-4 left-4 rounded-lg text-gray-500 dark:text-gray-400 font-semibold transition"
              style="/* box-shadow: 0 0 8px #ddd8 inset */;"
            >
              Settings
            </button>
        </div>
    </form>

    <script>
      (function() {
        const storagePrefix = "0xkuz/chat/";
        const settingsPrefix = `${storagePrefix}settings/`
        const settings = { API_KEY: null, PROXY: null, MODEL: "default" };

        // Check if API key is saved in local storage
        for (const [property, value] of Object.entries(settings)) {
          if (value) continue;

          if (localStorage.getItem(`${settingsPrefix}${property}`)) {
            settings[property] = localStorage.getItem(`${settingsPrefix}${property}`);
          } else {
            document.getElementById('propertiesForm').classList.remove('hidden');
            break;
          }
        }

        // Save API key to local storage and hide the form
        document.getElementById('propertiesForm').addEventListener('submit', function saveProperties(event) {
          event.preventDefault();
          const fd = new FormData(event.target);

          console.log({fd});
          // return fd;
          
          settings.API_KEY = fd.get('api_key').trim();
          settings.PROXY = fd.get('proxy').trim();

          // localStorage.setItem(`${settingsPrefix}/API_KEY`, settings.API_KEY);
          // localStorage.setItem(`${settingsPrefix}/PROXY`, settings.PROXY);

          localStorage.setItem(`${settingsPrefix}API_KEY`, (settings.API_KEY = fd.get('api_key').trim()));
          localStorage.setItem(`${settingsPrefix}PROXY`, (settings.PROXY = fd.get('proxy').trim()));

          document.getElementById('propertiesForm').classList.add('hidden');
        });

        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage('user', message);
            messageInput.value = '';

            try {
                const response = await aiCall(message);
                addMessage('ai', response);
            } catch (error) {
                addMessage('ai', '**Error:** Could not get response');
                console.error(error);
            }

            document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
        });

        function addMessage(sender, message) {
            /** @type {HTMLElement} */
            const template = document.getElementById('messageTemplate').cloneNode(true);
            template.classList.remove('hidden');

            const isUser = sender === 'user';

            // Set the message content
            template.querySelector('.message-text').textContent = message;
            template.querySelector('.sender-avatar').src = "";

            // Set sender-specific classes, names, and backgrounds
            template.querySelector('.sender-avatar').classList.remove(isUser? 'bg-gray-300': 'bg-yellow-400');
            template.querySelector('.sender-avatar').setAttribute('alt', isUser? 'Me': 'AI');
            template.querySelector('.sender-name').textContent = isUser? 'Me': 'AI Assistant';

            document.getElementById('chatContainer').appendChild(template);
        }

        async function aiCall(query) {
            if (!settings.API_KEY) {
                throw new Error('API key is missing');
            }

            // /*
            const options = {
                method: 'POST',
                headers: {Authorization: 'Bearer <token>', 'Content-Type': 'application/json'},
                body: JSON.stringify({"model":"llama-3.3-70b","messages":[{"role":"user","content":"<string>"}],"venice_parameters":{"enable_web_search":"auto","include_venice_system_prompt":true,"character_slug":"venice"},"frequency_penalty":0,"presence_penalty":0,"repetition_penalty":1.2,"n":1,"max_tokens":123,"max_temp":1.5,"min_temp":0.1,"max_completion_tokens":123,"temperature":0.7,"top_k":40,"top_p":0.9,"min_p":0.05,"stop":"<string>","stop_token_ids":[151643,151645],"stream":true,"stream_options":{"include_usage":true},"user":"<string>","parallel_tool_calls":false,"tools":[{"id":"<string>","type":"<string>","function":{"description":"<string>","name":"<string>","parameters":{}}}],"tool_choice":{"type":"<string>","function":{"name":"<string>"}},"response_format":{"type":"json_schema","json_schema":{"type":"object","properties":{"name":{"type":"string"},"age":{"type":"number"}},"required":["name","age"]}}})
            };
            // */

            const response = await fetch(settings.PROXY + 'https://api.venice.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${settings.API_KEY}`
                },
                body: JSON.stringify({
                    "model": settings.MODEL,
                    "messages": [{role: "user", content: query}],
                    // "max_tokens": 150
                })
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();
            return data.choices[0].message.content.trim();
        }
      })();
    </script>
</body>

</html>