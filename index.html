<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <script src="./tailwindcss-3.4.14.js"></script>
</head>

<body class="bg-gray-100 h-screen flex flex-col">
    <div id="apiKeyForm" class="bg-white p-4 shadow-lg relative mb-4 hidden">
        <div class="relative max-w-2xl mx-auto w-full">
            <label for="apiKeyInput" class="block text-gray-700 text-sm font-bold mb-2">Enter your OpenAI API Key:</label>
            <input id="apiKeyInput" type="text" placeholder="Your API Key"
                class="w-full h-10 p-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 resize-none mb-2">
            <button id="saveApiKeyButton"
                class="bg-yellow-400 text-black px-4 py-2 rounded-lg hover:bg-yellow-300 transition">
                Save API Key
            </button>
        </div>
    </div>

    <div class="flex-1 overflow-y-auto p-4 w-full">
        <div id="chatContainer" class="space-y-4 max-w-2xl mx-auto w-full">
            <!-- Reusable message template -->
            <div id="messageTemplate" class="hidden message-template flex items-start gap-2">
                <div class="flex flex-col items-start w-full">
                    <div class="flex items-center mb-1">
                        <img src="" alt="Sender"
                            class="sender-avatar size-12 inline-block rounded-full p-2 mr-2 overflow-hidden align-middle bg-gray-300 bg-yellow-400 text-center leading-[2em]">
                        <span class="sender-name text-gray-600 font-semibold">Sender Name</span>
                    </div>
                    <div class="message-content bg-white p-3 rounded-lg">
                        <p class="message-text text-gray-800 whitespace-pre-wrap">Message Content</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form id="chatForm" class="bg-white p-4 shadow-lg relative">
        <div class="relative max-w-2xl mx-auto w-full">
            <textarea id="messageInput" placeholder="Type your message..."
                class="w-full h-32 p-4 pb-14 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 resize-none"
                rows="4"></textarea>
            <button type="submit"
                class="absolute bottom-2 right-2 bg-yellow-400 text-black px-4 py-2 rounded-lg hover:bg-yellow-300 transition mb-2">
                Send
            </button>
        </div>
    </form>

    <script>
        (function() {
        let apiKey;

        // Check if API key is saved in local storage
        if (localStorage.getItem('openaiApiKey')) {
            apiKey = localStorage.getItem('openaiApiKey');
        } else {
            document.getElementById('apiKeyForm').classList.remove('hidden');
        }

        // Save API key to local storage and hide the form
        document.getElementById('saveApiKeyButton').addEventListener('click', () => {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            localStorage.setItem('openaiApiKey', apiKey);
            document.getElementById('apiKeyForm').classList.add('hidden');
        });

        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage('user', message);
            messageInput.value = '';

            try {
                const response = await aiCall(message);
                addMessage('ai', response);
            } catch (error) {
                addMessage('ai', '**Error:** Could not get response');
                console.error(error);
            }

            document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
        });

        function addMessage(sender, message) {
            /** @type {HTMLElement} */
            const template = document.getElementById('messageTemplate').cloneNode(true);
            template.classList.remove('hidden');

            const isUser = sender === 'user';

            // Set the message content
            template.querySelector('.message-text').textContent = message;
            template.querySelector('.sender-avatar').src = "";

            // Set sender-specific classes, names, and backgrounds
            template.querySelector('.sender-avatar').classList.remove(isUser? 'bg-gray-300': 'bg-yellow-400');
            template.querySelector('.sender-avatar').setAttribute('alt', isUser? 'Me': 'AI');
            template.querySelector('.sender-name').textContent = isUser? 'Me': 'AI Assistant';

            document.getElementById('chatContainer').appendChild(template);
        }

        async function aiCall(query) {
            if (!apiKey) {
                throw new Error('API key is missing');
            }

            // /*
            const options = {
                method: 'POST',
                headers: {Authorization: 'Bearer <token>', 'Content-Type': 'application/json'},
                body: JSON.stringify({"model":"llama-3.3-70b","messages":[{"role":"user","content":"<string>"}],"venice_parameters":{"enable_web_search":"auto","include_venice_system_prompt":true,"character_slug":"venice"},"frequency_penalty":0,"presence_penalty":0,"repetition_penalty":1.2,"n":1,"max_tokens":123,"max_temp":1.5,"min_temp":0.1,"max_completion_tokens":123,"temperature":0.7,"top_k":40,"top_p":0.9,"min_p":0.05,"stop":"<string>","stop_token_ids":[151643,151645],"stream":true,"stream_options":{"include_usage":true},"user":"<string>","parallel_tool_calls":false,"tools":[{"id":"<string>","type":"<string>","function":{"description":"<string>","name":"<string>","parameters":{}}}],"tool_choice":{"type":"<string>","function":{"name":"<string>"}},"response_format":{"type":"json_schema","json_schema":{"type":"object","properties":{"name":{"type":"string"},"age":{"type":"number"}},"required":["name","age"]}}})
            };
            // */

            const response = await fetch('https://api.venice.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    "model": "qwen-2.5-coder-32b",
                    "messages": [{role: "user", content: query}],
                    "max_tokens": 150
                })
            });

            if (!response.ok) {
                throw new Error('Network response was not ok');
            }

            const data = await response.json();
            return data.choices[0].message.content.trim();
        }
        })();
    </script>
</body>

</html>